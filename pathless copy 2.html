<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{.Title}}</title>
		<link rel="icon" type="image/" href="{{.Favicon}}" />
		<style>
			:root {
				--border: medium solid blue;
			}
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				user-select: none;
				scrollbar-width: none;
				-ms-overflow-style: none;
			}
			*::-webkit-scrollbar {
				display: none;
			}
			html,
			body {
				height: 100vh;
				overflow: hidden;
				font-family: sans-serif, monospace;
				background: black;
				color: white;
				scroll-behavior: smooth;
			}
			body {
				border: var(--border);
				border-radius: 0.3125em;
			}
			a {
				color: inherit;
				text-decoration: underline;
				text-align: center;
			}
			#app {
				height: 100vh;
				display: grid;
			}
			.panel {
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 1em;
				overflow: hidden;
			}
			.panel > * {
				width: 100%;
				height: 100%;
			}
			/* Layout 0-0: Single fullscreen panel */
			.layout-0-0 {
				grid-template: 1fr / 1fr;
			}
			/* Layout 1-0: Two panels side-by-side */
			.layout-1-0 {
				grid-template: 1fr / 1fr 1fr;
			}
			.layout-1-0 #zero {
				border-right: var(--border);
			}
			/* Layout 1-1: Two panels stacked vertically */
			.layout-1-1 {
				grid-template: 1fr 1fr / 1fr;
			}
			.layout-1-1 #zero {
				border-bottom: var(--border);
			}
			/* Layout 2-x: Three panels in 2x2 grid */
			.layout-2-0,
			.layout-2-1,
			.layout-2-2,
			.layout-2-3 {
				grid-template: 1fr 1fr / 1fr 1fr;
			}
			/* Layout 2-0: Left full-height, right split */
			.layout-2-0 #zero {
				grid-row: 1 / 3;
				border-right: var(--border);
			}
			.layout-2-0 #one {
				border-bottom: var(--border);
			}
			/* Layout 2-1: Top full-width, bottom split */
			.layout-2-1 #zero {
				grid-column: 1 / 3;
				border-bottom: var(--border);
			}
			.layout-2-1 #one {
				border-right: var(--border);
			}
			/* Layout 2-2: Right full-height, left split */
			.layout-2-2 #zero {
				grid-row: 1 / 3;
				grid-column: 2;
				border-left: var(--border);
			}
			.layout-2-2 #one {
				border-bottom: var(--border);
			}
			/* Layout 2-3: Bottom full-width, top split */
			.layout-2-3 #zero {
				grid-row: 2;
				grid-column: 1 / 3;
				border-top: var(--border);
			}
			.layout-2-3 #one {
				border-right: var(--border);
			}
		</style>
		<script>
			class One {
				constructor() {
					window.apiUrl = '{{.APIURL}}';
					this.fx = new Fx();
					this.handlers = new Map();
					this.fx.render();
					document.addEventListener('keydown', (e) => {
						const actions = {
							e: () => this.fx.navigate(1),
							q: () => this.fx.navigate(-1),
							1: () => this.fx.setLayout(0),
							2: () => this.fx.setLayout(1),
							3: () => this.fx.setLayout(2),
							Tab: () => (
								e.preventDefault(), this.fx.cycleFocus()
							),
						};
						(actions[e.key] || (() => this.handleKey(e.key)))();
					});
				}

				handleKey(key, handler) {
					const panel = this.fx.panel;
					const k = `${panel.id}-${panel.frame}`;
					if (handler) {
						this.handlers.set(k, handler);
					} else {
						this.handlers.get(k)?.(key);
					}
				}
			}

			/* Layout & rendering manager */
			class Fx {
				constructor() {
					this.zero = new Zero();
					this.layout = [0, 0];
					this.focus = 0;
					this.prev = null;
					this.variants = [0, 1, 3];
				}

				get panel() {
					return this.zero.panels[this.focus];
				}

				get count() {
					return this.layout[0] + 1;
				}

				get state() {
					const panel = this.panel;
					const frame = panel.frame;
					return panel.state.get(frame) || {};
				}

				update(k, v) {
					const panel = this.panel;
					const frame = panel.frame;
					if (!panel.state.has(frame)) panel.state.set(frame, {});
					panel.state.get(frame)[k] = v;
				}

				async setLayout(i) {
					if (i === 0) {
						if (this.layout[0] === 0 && this.prev) {
							this.layout = [...this.prev];
							this.prev = null;
						} else if (this.layout[0] !== 0) {
							this.prev = [...this.layout];
							this.layout = [0, 0];
						}
					} else {
						this.prev = null;
						this.focus = Math.min(this.focus, i);
						const numVariants = this.variants[i] + 1;
						if (this.layout[0] === i) {
							this.layout = [
								this.layout[0],
								(this.layout[1] + 1) % numVariants,
							];
						} else {
							this.layout = [i, 0];
						}
					}
					await this.render();
				}

				cycleFocus() {
					this.focus = (this.focus + 1) % this.count;
					this.display();
				}

				async navigate(d) {
					const panel = this.zero.panels[this.focus];
					const total = this.zero.total;
					if (total !== null) {
						panel.frame[0] =
							(((panel.frame[0] + d) % total) + total) % total;
					}

					try {
						const res = await this.zero.fetch(
							`${window.apiUrl}/frame`,
							{
								headers: { 'X-Frame': String(panel.frame[0]) },
								key: panel.frame[0],
							}
						);

						this.zero.total = parseInt(
							res.headers.get('X-Frames'),
							10
						);
						panel.frame[0] = parseInt(
							res.headers.get('X-Frame'),
							10
						);
						panel.frame[1] = res.data;
						const tmp = document.createElement('div');
						tmp.innerHTML = panel.frame[1];
						panel.frame[2] = Array.from(tmp.childNodes).map(
							(node) => node.cloneNode(true)
						);
					} catch (e) {
						panel.frame[1] = `<div>Error: ${e.message}</div>`;
						panel.frame[2] = [
							document.createTextNode(panel.frame[1]),
						];
					}
					this.render(panel);
					this.display();
				}

				render(panel) {
					const nodes = panel.frame[2];
					if (!nodes) return;
					panel.innerHTML = '';
					nodes.forEach((node) =>
						panel.appendChild(node.cloneNode(true))
					);
					panel._lastHtml = panel.frame[1];
				}

				async renderAll() {
					for (let i = 0; i < this.count; i++) {
						this.render(this.zero.panels[i]);
					}
					this.display();
				}

				display() {
					requestAnimationFrame(() => {
						this.zero.app.className = `layout-${this.layout[0]}-${this.layout[1]}`;
						this.zero.panels.forEach((p, i) => {
							p.style.display =
								this.layout[0] === 0
									? i === this.focus
										? 'flex'
										: 'none'
									: i < this.count
									? 'flex'
									: 'none';
						});
					});
				}
			}

			/* Data fetching & caching */
			class Zero {
				constructor() {
					this.app = document.getElementById('app');
					this.panels = ['zero', 'one', 'two'].map((id) => {
						const el = document.getElementById(id);
						el.frame = [0, null];
						el.state = new Map();
						return el;
					});
					this.cache = new Map();
					this.total = null;
					this.listeners = {};
				}

				on(event, cb) {
					(this.listeners[event] ||= []).push(cb);
				}

				emit(event, ...args) {
					(this.listeners[event] || []).forEach((cb) => cb(...args));
				}

				async fetch(url, opts = {}) {
					const k = opts.key;
					if (k !== undefined) {
						const cached = this.cache.get(k);
						if (cached) {
							return cached instanceof Promise ? cached : cached;
						}
					}
					const p = fetch(url, opts).then(async (r) => {
						if (!r.ok) throw new Error(`HTTP ${r.status}`);
						const ct = r.headers.get('content-type') || '';
						const data = ct.startsWith('image/')
							? URL.createObjectURL(await r.blob())
							: ct.includes('json')
							? await r.json()
							: await r.text();
						const res = { data, headers: r.headers };
						if (k !== undefined) this.cache.set(k, res);
						return res;
					});

					if (k !== undefined) this.cache.set(k, p);
					return p;
				}
			}

			document.addEventListener('DOMContentLoaded', () => {
				window.one = new One();
				window.pathless = {
					context: () => ({
						panel: window.one.fx.panel,
						frame: window.one.fx.panel.firstElementChild,
						state: window.one.fx.state,
					}),
					update: (k, v) => window.one.fx.update(k, v),
					fetch: (url, opts) => window.one.fx.zero.fetch(url, opts),
					onKey: (h) => window.one.fx.handleKey(null, h),
				};
			});
		</script>
	</head>
	<body>
		<div id="app">
			<div id="zero" class="panel"></div>
			<div id="one" class="panel"></div>
			<div id="two" class="panel"></div>
		</div>
	</body>
</html>
