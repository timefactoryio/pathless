<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>hello.universe</title>
		<style>
			:root {
				--b: medium solid blue;
			}
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				user-select: none;
				scrollbar-width: none;
			}
			*::-webkit-scrollbar {
				display: none;
			}
			html,
			body {
				height: 100vh;
				overflow: hidden;
				font-family: sans-serif;
				background: #000;
				color: #fff;
			}
			body {
				border: var(--b);
				border-radius: 5px;
			}
			a {
				color: inherit;
				text-decoration: none;
			}
			#app {
				height: 100vh;
				display: grid;
			}
			.space {
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 1em;
				overflow: hidden;
			}
			.space.hide {
				display: none;
			}
			.space > * {
				width: 100%;
				height: 100%;
			}
			.l00 {
				grid-template: 1fr / 1fr;
			}
			.l10 {
				grid-template: 1fr / 1fr 1fr;
			}
			.l10 .zero {
				border-right: var(--b);
			}
			.l11 {
				grid-template: 1fr 1fr / 1fr;
			}
			.l11 .zero {
				border-bottom: var(--b);
			}
			.l20,
			.l21,
			.l22,
			.l23 {
				grid-template: 1fr 1fr / 1fr 1fr;
			}
			.l20 .zero {
				grid-row: 1/3;
				border-right: var(--b);
			}
			.l20 .one {
				border-bottom: var(--b);
			}
			.l21 .zero {
				grid-column: 1/3;
				border-bottom: var(--b);
			}
			.l21 .one {
				border-right: var(--b);
			}
			.l22 .zero {
				grid-row: 1/3;
				grid-column: 2;
				border-left: var(--b);
			}
			.l22 .one {
				border-bottom: var(--b);
			}
			.l23 .zero {
				grid-row: 2;
				grid-column: 1/3;
				border-top: var(--b);
			}
			.l23 .one {
				border-right: var(--b);
			}
		</style>
		<script>
			window.apiUrl = '{{.APIURL}}';
			class Universe {
				constructor() {
					this.space = [
						{ el: document.querySelector('.zero') },
						{ el: document.querySelector('.one') },
						{ el: document.querySelector('.two') },
					];
					this.keybinds = {};
					this.layout = [0, 0];
					this.prevLayout = [0, 0];
					this.focused = 0;

					this.onKey('1', () => this.toggleFullscreen());
					this.onKey('2', () => this.setLayout(1));
					this.onKey('3', () => this.setLayout(2));
					this.onKey('Tab', () => this.cycleFocus());

					window.addEventListener('keydown', (e) =>
						this.handleKey(e, true, 'onDown')
					);
					window.addEventListener('keyup', (e) =>
						this.handleKey(e, false, 'onUp')
					);
					window.addEventListener('render', () =>
						this.updateDisplay()
					);
					this.render();
				}

				handleKey(event, isPressed, callback) {
					const key = event.key.toLowerCase();
					const bind = this.keybinds[key];
					if (bind) {
						event.preventDefault();
						bind.pressed = isPressed;
						bind[callback]?.(event);
					}
				}

				onKey(key, onDown, onUp) {
					this.keybinds[key.toLowerCase()] = {
						pressed: false,
						onDown,
						onUp,
					};
					return this;
				}

				offKey(key) {
					delete this.keybinds[key.toLowerCase()];
					return this;
				}

				keyboard() {
					return Object.entries(this.keybinds).map(
						([key, { pressed }]) => ({
							key,
							pressed,
						})
					);
				}

				updateDisplay() {
					app.className = 'l' + this.layout.join('');
					const visible = this.layout[0] + 1;
					this.space.forEach((space, index) => {
						const shouldShow = this.layout[0]
							? index < visible
							: index === this.focused;
						space.el.classList.toggle('hide', !shouldShow);
					});
				}

				render() {
					window.dispatchEvent(new Event('render'));
				}

				toggleFullscreen() {
					if (this.layout[0]) {
						this.prevLayout = [...this.layout];
						this.layout = [0, 0];
					} else {
						this.layout = [...this.prevLayout];
					}
					this.render();
				}

				setLayout(spaceCount) {
					this.prevLayout = [...this.layout];
					this.focused = Math.min(this.focused, spaceCount);
					this.layout =
						this.layout[0] === spaceCount
							? [
									spaceCount,
									(this.layout[1] + 1) %
										[0, 2, 4][spaceCount],
							  ]
							: [spaceCount, 0];
					this.render();
				}

				cycleFocus() {
					this.focused = (this.focused + 1) % (this.layout[0] + 1);
					this.render();
				}
			}

			document.addEventListener('DOMContentLoaded', () => {
				const u = new Universe();
				window.pathless = {
					space: (index) => u.space[index ?? u.focused].el,
					onKey: (key, onDown, onUp) => u.onKey(key, onDown, onUp),
					offKey: (key) => u.offKey(key),
					keyboard: () => u.keyboard(),
				};
			});
		</script>
	</head>
	<body>
		<div id="app">
			<div class="space zero"></div>
			<div class="space one"></div>
			<div class="space two"></div>
		</div>
	</body>
</html>
