<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>hello.universe</title>
		<style>
			:root {
				--b: medium solid blue;
			}
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				user-select: none;
				scrollbar-width: none;
			}
			*::-webkit-scrollbar {
				display: none;
			}
			html,
			body {
				height: 100vh;
				overflow: hidden;
				font-family: sans-serif;
				background: #000;
				color: #fff;
			}
			body {
				border: var(--b);
				border-radius: 5px;
			}
			a {
				color: inherit;
				text-decoration: none;
			}
			#universe {
				height: 100vh;
				display: grid;
				position: relative;
			}
			.space {
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 1em;
				overflow: hidden;
				position: relative;
			}
			.space.hide {
				display: none;
			}
			.space > * {
				width: 100%;
				height: 100%;
			}
			.l00 {
				grid-template: 1fr / 1fr;
			}
			.l10 {
				grid-template: 1fr / 1fr 1fr;
			}
			.l10 #zero {
				border-right: var(--b);
			}
			.l11 {
				grid-template: 1fr 1fr / 1fr;
			}
			.l11 #zero {
				border-bottom: var(--b);
			}
			.l20,
			.l21,
			.l22,
			.l23 {
				grid-template: 1fr 1fr / 1fr 1fr;
			}
			.l20 #zero {
				grid-row: 1/3;
				border-right: var(--b);
			}
			.l20 #one {
				border-bottom: var(--b);
			}
			.l21 #zero {
				grid-column: 1/3;
				border-bottom: var(--b);
			}
			.l21 #one {
				border-right: var(--b);
			}
			.l22 #zero {
				grid-row: 1/3;
				grid-column: 2;
				border-left: var(--b);
			}
			.l22 #one {
				border-bottom: var(--b);
			}
			.l23 #zero {
				grid-row: 2;
				grid-column: 1/3;
				border-top: var(--b);
			}
			.l23 #one {
				border-right: var(--b);
			}
			#overlay {
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				display: none;
				align-items: center;
				justify-content: center;
				padding: 0.5em;
				z-index: 999;
			}
			#overlay.show {
				display: flex;
			}
			#overlay > .grid {
				background: rgba(0, 0, 0, 1);
				display: grid;
				grid-template: repeat(3, 1fr) / repeat(3, 1fr);
				gap: 0.5em;
				max-width: 26vw;
			}
			.key {
				width: 10em;
				height: 5em;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				overflow: hidden;
				border: medium solid #444;
				border-radius: 3px;
				font-weight: bold;
			}
			.key.q {
				border-color: red;
			}
			.key.e {
				border-color: blue;
			}
			.key.pressed,
			.key.q.pressed,
			.key.e.pressed {
				border-color: white;
			}
			.key.q span,
			.key.e span {
				font-size: 1em;
			}
			.key kbd {
				font-size: 1.2em;
				height: 2em;
				min-height: 2em;
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				flex-shrink: 0;
				color: #aaa;
			}
			.key span {
				font-size: 1.5em;
				flex: 1;
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: hidden;
			}
			.key span svg {
				padding-bottom: 0.2em;
				width: 100%;
				height: 100%;
				object-fit: contain;
			}
			.kbd-hint {
				border: 2px solid blue;
				padding: 0.3em 0.6em;
				border-radius: 3px;
				font-weight: bold;
				margin-left: 0.3em;
			}
			.hint {
				position: absolute;
				bottom: 3em;
				left: 50%;
				transform: translateX(-50%);
				color: #ffffff;
				font-size: clamp(1rem, 2vw, 1.5rem);
				pointer-events: none;
			}
		</style>
		<script>
			class Universe {
				constructor() {
					window.apiUrl = '{{.APIURL}}';
					this.universe = document.getElementById('universe');
					this.overlay = document.getElementById('overlay');
					this.grid = {
						el: this.overlay.querySelector('.grid'),
						keys: [...this.overlay.querySelectorAll('.key')].map(
							(keyDiv) => {
								const key = keyDiv.classList[1];
								const kbd = keyDiv.querySelector('kbd');
								kbd.textContent = key;
								return {
									key,
									el: keyDiv,
									span: keyDiv.querySelector('span'),
								};
							}
						),
					};
					this.space = ['zero', 'one', 'two'].map((id) => ({
						el: document.getElementById(id),
						frame: [0, null],
						state: new Map(),
					}));
					this.frames = [];
					this.layouts = [];
					this.layout = [0, 0];
					this.prevLayout = [0, 0];
					this.focused = 0;
					this.cache = new Map();
					this.keybinds = new Map();

					window.addEventListener('keydown', (e) =>
						this.handleKey(e, true)
					);
					window.addEventListener('keyup', (e) =>
						this.handleKey(e, false)
					);
					this.init();
				}

				async init() {
					const { frames, layouts } = await this.fetch(window.apiUrl);
					this.frames = frames;
					this.layouts = layouts;

					this.onKey('tab', () => this.cycleFocus(), true);
					this.onKey('1', () => this.fullscreen(), true);
					this.onKey('2', () => this.setLayout(1), true);
					this.onKey('3', () => this.setLayout(2), true);
					this.onKey('q', () => this.nav(-1), true, 'back');
					this.onKey('e', () => this.nav(1), true, 'next');
					this.onKey('z', () => this.toggleOverlay(), true);
					this.sync();
				}

				handleKey(e, pressed) {
					const key = e.key.toLowerCase();
					const bind = this.keybinds.get(key);
					if (!bind) return;
					e.preventDefault();
					bind.pressed = pressed;
					bind.el?.classList.toggle('pressed', pressed);
					if (pressed) bind.fx?.(e);
				}

				onKey(key, fx, global = false, desc = null) {
					key = key.toLowerCase();
					const overlayKey = this.grid.keys.find(
						(k) => k.key === key
					);
					this.keybinds.set(key, {
						fx,
						global,
						pressed: false,
						desc,
						el: overlayKey?.el,
						span: overlayKey?.span,
					});
					return this;
				}

				write(key, value) {
					const s = this.space[this.focused];
					if (!s.state.has(s.frame[0]))
						s.state.set(s.frame[0], new Map());
					s.state.get(s.frame[0]).set(key, value);
				}

				read() {
					const s = this.space[this.focused];
					const frameState = s.state.get(s.frame[0]);
					return frameState ? Object.fromEntries(frameState) : {};
				}

				fullscreen() {
					[this.layout, this.prevLayout] = this.layout[0]
						? [[0, 0], this.layout]
						: [this.prevLayout, this.prevLayout];
					this.sync();
				}

				setLayout(n) {
					this.focused = Math.min(this.focused, n);
					this.layout = [
						n,
						this.layout[0] === n
							? (this.layout[1] + 1) %
							  this.layouts[n].variants.length
							: 0,
					];
					this.sync();
				}

				cycleFocus() {
					this.focused = (this.focused + 1) % (this.layout[0] + 1);
					this.sync();
				}

				nav(dir) {
					const s = this.space[this.focused];
					s.frame[0] =
						(s.frame[0] + dir + this.frames.length) %
						this.frames.length;
					this.sync();
				}

				toggleOverlay() {
					this.overlay.classList.toggle('show');
					this.sync();
				}

				updateOverlay() {
					if (!this.overlay.classList.contains('show')) return;
					for (const [key, bind] of this.keybinds) {
						if (!bind.span) continue;
						if (['1', '2', '3'].includes(key)) {
							const n = parseInt(key);
							const layout = this.layouts[n - 1];
							if (!layout) continue;
							const nextIdx =
								n === 1
									? 0
									: this.layout[0] === n - 1
									? (this.layout[1] + 1) %
									  layout.variants.length
									: 0;
							bind.span.innerHTML = layout.variants[nextIdx].svg;
						} else {
							bind.span.textContent = bind.desc || '';
						}
					}
				}

				updateHint() {
					const shouldShow =
						this.focused === 0 &&
						this.space[0].frame[0] === 0 &&
						this.layout[0] === 0 &&
						!this.overlay.classList.contains('show');

					const existing = this.space[0].el.querySelector('.hint');
					if (shouldShow && !existing) {
						const hint = document.createElement('div');
						hint.className = 'hint';
						hint.innerHTML = 'Press <kbd class="kbd-hint">Z</kbd>';
						this.space[0].el.appendChild(hint);
					} else if (!shouldShow && existing) {
						existing.remove();
					}
				}

				exec(space) {
					for (const [key, bind] of this.keybinds) {
						if (!bind.global) {
							bind.el?.classList.remove('pressed');
							bind.span && (bind.span.textContent = '');
							this.keybinds.delete(key);
						}
					}
					const html = this.frames[space.frame[0]];
					space.el.innerHTML = html;
					space.frame[1] = html;
					space.el
						.querySelectorAll('script, style')
						.forEach((old) => {
							const n = document.createElement(
								old.tagName.toLowerCase()
							);
							[...old.attributes].forEach((a) =>
								n.setAttribute(a.name, a.value)
							);
							n.textContent = old.textContent;
							old.replaceWith(n);
						});
				}

				sync() {
					const layout = this.layouts[this.layout[0]];
					this.universe.className =
						layout.variants[this.layout[1]].class;

					this.space.forEach((s, i) => {
						const visible =
							this.layout[0] === 0
								? i === this.focused
								: i < layout.visible;
						s.el.classList.toggle('hide', !visible);

						const needsExec =
							this.frames[s.frame[0]] !== s.frame[1] ||
							i === this.focused;
						if (visible && needsExec) {
							this.exec(s);
						}
					});

					this.updateOverlay();
					this.updateHint();
				}

				async fetch(url) {
					if (this.cache.has(url)) return this.cache.get(url);
					const promise = fetch(url).then(async (r) => {
						if (!r.ok) throw new Error(`HTTP ${r.status}`);
						const ct = r.headers.get('content-type') || '';
						return ct.includes('json')
							? await r.json()
							: await r.text();
					});
					this.cache.set(url, promise);
					return promise;
				}
			}

			document.addEventListener('DOMContentLoaded', () => {
				const u = new Universe();
				window.pathless = {
					space: (index) => u.space[index ?? u.focused].el,
					frame: () => u.space[u.focused].el.firstElementChild,
					write: (key, value) => u.write(key, value),
					read: () => u.read(),
					fetch: (url) => u.fetch(url),
					onKey: (key, fx, desc) => u.onKey(key, fx, false, desc),
				};
			});
		</script>
	</head>
	<body>
		<div id="universe">
			<div class="space" id="zero"></div>
			<div class="space" id="one"></div>
			<div class="space" id="two"></div>
		</div>
		<div id="overlay">
			<div class="grid">
				<div class="key 1"><kbd></kbd><span></span></div>
				<div class="key 2"><kbd></kbd><span></span></div>
				<div class="key 3"><kbd></kbd><span></span></div>
				<div class="key q"><kbd></kbd><span></span></div>
				<div class="key w"><kbd></kbd><span></span></div>
				<div class="key e"><kbd></kbd><span></span></div>
				<div class="key a"><kbd></kbd><span></span></div>
				<div class="key s"><kbd></kbd><span></span></div>
				<div class="key d"><kbd></kbd><span></span></div>
			</div>
		</div>
	</body>
</html>
