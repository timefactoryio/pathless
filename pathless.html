<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>hello.universe</title>
		<style>
			:root {
				--b: 1px solid blue;
			}
			*,
			*::before,
			*::after {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				user-select: none;
				-webkit-user-select: none;
				scrollbar-width: none;
			}
			html,
			body {
				height: 100vh;
				overflow: hidden;
				font-family: sans-serif;
				background: #000;
				color: #fff;
			}
			body {
				border: var(--b);
				border-radius: 5px;
			}
			a {
				color: inherit;
				text-decoration: none;
			}
			#universe {
				height: 100vh;
				display: grid;
			}
			.space {
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: hidden;
			}
			.space.hide {
				display: none;
			}
			#control-panel {
				height: 25vh;
				border-top: var(--b);
				display: none;
			}
			.l00 {
				display: flex;
			}
			.l10 {
				grid-template: 1fr / 1fr 1fr;
			}
			.l10 #zero {
				border-right: var(--b);
			}
			.l11 {
				grid-template: 1fr 1fr / 1fr;
			}
			.l11 #zero {
				border-bottom: var(--b);
			}
			.l20,
			.l21,
			.l22,
			.l23 {
				grid-template: 1fr 1fr / 1fr 1fr;
			}
			.l20 #zero {
				grid-row: 1/3;
				border-right: var(--b);
			}
			.l20 #one {
				border-bottom: var(--b);
			}
			.l21 #zero {
				grid-column: 1/3;
				border-bottom: var(--b);
			}
			.l21 #one {
				border-right: var(--b);
			}
			.l22 #zero {
				grid-row: 1/3;
				grid-column: 2;
				border-left: var(--b);
			}
			.l22 #one {
				border-bottom: var(--b);
			}
			.l23 #zero {
				grid-row: 2;
				grid-column: 1/3;
				border-top: var(--b);
			}
			.l23 #one {
				border-right: var(--b);
			}
		</style>
		<script>
			class Universe {
				constructor() {
					window.apiUrl = '{{.APIURL}}';
					this.universe = document.getElementById('universe');
					this.space = ['zero', 'one', 'two', 'control-panel'].map(
						(id) => ({
							el: document.getElementById(id),
							index: 0,
							frame: null,
							state: new Map(),
							visible: false,
						}),
					);
					this.frames = [];
					this.layouts = [];
					this.layout = [0, 0];
					this.prevLayout = [0, 0];
					this.focused = 0;
					this.cache = new Map();
					this.keybinds = new Map();

					window.addEventListener('keydown', (e) =>
						this.handleKey(e, true),
					);
					window.addEventListener('keyup', (e) =>
						this.handleKey(e, false),
					);
					this.init();
				}

				async init() {
					const { frames, layouts, keyboard } = await this.fetch(
						window.apiUrl,
					);
					this.frames = frames;
					this.layouts = layouts;
					this.space[3].el.innerHTML = keyboard;
					this.space.forEach((s) =>
						frames.forEach((_, i) => s.state.set(i, new Map())),
					);
					this.space[0].visible = true;
					this.sync();
				}

				write(key, value) {
					this.space[this.focused].state
						.get(this.space[this.focused].index)
						.set(key, value);
				}

				read() {
					return Object.fromEntries(
						this.space[this.focused].state.get(
							this.space[this.focused].index,
						),
					);
				}

				handleKey(e, pressed) {
					const bind = this.keybinds.get(e.key.toLowerCase());
					if (!bind) return;
					e.preventDefault();
					bind.pressed = pressed;
					bind.el?.classList.toggle('pressed', pressed);
					if (pressed) bind.fx?.(e);
				}

				onKey(key, fx, global = false, desc = null) {
					const existing = this.keybinds.get(key.toLowerCase());
					this.keybinds.set(key.toLowerCase(), {
						fx,
						global,
						pressed: false,
						desc,
						el: existing?.el || null,
					});
					return this;
				}

				setLayout(n) {
					if (n === 0) {
						[this.layout, this.prevLayout] = this.layout[0]
							? [[0, 0], this.layout]
							: [this.prevLayout, this.prevLayout];
					} else {
						this.focused = Math.min(this.focused, n);
						this.layout = [
							n,
							this.layout[0] === n
								? (this.layout[1] + 1) %
									this.layouts[n].variants.length
								: 0,
						];
					}
					this.sync();
				}

				cycleFocus() {
					this.cleanup();
					this.focused = (this.focused + 1) % (this.layout[0] + 1);
					this.sync();
				}

				nav(dir) {
					this.cleanup();
					const s = this.space[this.focused];
					s.index =
						(s.index + dir + this.frames.length) %
						this.frames.length;
					this.sync();
				}

				cleanup() {
					for (const [key, bind] of this.keybinds) {
						if (bind.global) continue;
						bind.el?.classList.remove('pressed');
						this.keybinds.delete(key);
					}
				}

				exec(el) {
					el.querySelectorAll('script, style').forEach((old) => {
						const fresh = document.createElement(
							old.tagName.toLowerCase(),
						);
						[...old.attributes].forEach((attr) =>
							fresh.setAttribute(attr.name, attr.value),
						);
						fresh.textContent = old.textContent;
						old.replaceWith(fresh);
					});
				}

				sync() {
					const layout = this.layouts[this.layout[0]];
					this.universe.className =
						layout.variants[this.layout[1]].class;

					this.space.forEach((s, i) => {
						if (i === 3) return;
						s.visible =
							this.layout[0] === 0
								? i === this.focused
								: i < layout.visible;
						s.el.classList.toggle('hide', !s.visible);
						if (s.visible) {
							if (this.frames[s.index] !== s.frame) {
								s.el.innerHTML = this.frames[s.index];
								s.frame = this.frames[s.index];
							}
							if (i === this.focused) this.exec(s.el);
						}
					});
					if (this.space[3].visible) this.exec(this.space[3].el);
				}

				async fetch(url) {
					if (this.cache.has(url)) return this.cache.get(url);
					const promise = fetch(url).then(async (r) => {
						if (!r.ok) throw new Error(`HTTP ${r.status}`);
						return r.headers.get('content-type')?.includes('json')
							? r.json()
							: r.text();
					});
					this.cache.set(url, promise);
					return promise;
				}

				togglePanel() {
					this.space[3].visible = !this.space[3].visible;
					this.universe.style.height = this.space[3].visible
						? '75vh'
						: '100vh';
					this.space[3].el.style.display = this.space[3].visible
						? 'flex'
						: 'none';
					this.sync();
				}
			}

			document.addEventListener('DOMContentLoaded', () => {
				const u = (window.pathless = new Universe());
				u.onKey('tab', () => u.cycleFocus(), true);
				u.onKey('1', () => u.setLayout(0), true);
				u.onKey('2', () => u.setLayout(1), true);
				u.onKey('3', () => u.setLayout(2), true);
				u.onKey('q', () => u.nav(-1), true, 'back');
				u.onKey('e', () => u.nav(1), true, 'next');
				u.onKey('z', () => u.togglePanel(), true);
				window.space = (i) => u.space[i ?? u.focused].el;
				window.frame = () => u.space[u.focused].el.firstElementChild;
				window.onKey = (key, fx, desc) => u.onKey(key, fx, false, desc);
			});
		</script>
	</head>
	<body>
		<div id="universe">
			<div class="space" id="zero"></div>
			<div class="space" id="one"></div>
			<div class="space" id="two"></div>
		</div>
		<div class="space" id="control-panel"></div>
	</body>
</html>
