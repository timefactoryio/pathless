<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>hello.universe</title>
		<style>
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				user-select: none;
			}
			*::-webkit-scrollbar {
				display: none;
			}
			html,
			body {
				height: 100vh;
				overflow: hidden;
				font-family: sans-serif;
				background: #000;
				color: #fff;
			}
			body {
				border: 2px solid blue;
				border-radius: 5px;
			}
			a {
				color: inherit;
				text-decoration: none;
			}

			#universe {
				height: 100vh;
				display: grid;
			}
			.space {
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 1em;
				overflow: hidden;
			}
			.space.hide {
				display: none;
			}
			.space > * {
				width: 100%;
				height: 100%;
			}

			.l0 {
				grid-template: 1fr / 1fr;
			}
			.l1-0 {
				grid-template: 1fr / 1fr 1fr;
			}
			.l1-0 #s0 {
				border-right: 2px solid blue;
			}
			.l1-1 {
				grid-template: 1fr 1fr / 1fr;
			}
			.l1-1 #s0 {
				border-bottom: 2px solid blue;
			}
			.l2-0,
			.l2-1,
			.l2-2,
			.l2-3 {
				grid-template: 1fr 1fr / 1fr 1fr;
			}
			.l2-0 #s0 {
				grid-row: 1/3;
				border-right: 2px solid blue;
			}
			.l2-0 #s1 {
				border-bottom: 2px solid blue;
			}
			.l2-1 #s0 {
				grid-column: 1/3;
				border-bottom: 2px solid blue;
			}
			.l2-1 #s1 {
				border-right: 2px solid blue;
			}
			.l2-2 #s0 {
				grid-row: 1/3;
				grid-column: 2;
				border-left: 2px solid blue;
			}
			.l2-2 #s1 {
				border-bottom: 2px solid blue;
			}
			.l2-3 #s0 {
				grid-row: 2;
				grid-column: 1/3;
				border-top: 2px solid blue;
			}
			.l2-3 #s1 {
				border-right: 2px solid blue;
			}
		</style>
	</head>
	<body>
		<div id="universe">
			<div class="space" id="s0"></div>
			<div class="space" id="s1"></div>
			<div class="space" id="s2"></div>
		</div>

		<script>
			class Universe {
				constructor() {
					this.api = '{{.APIURL}}';
					this.spaces = [0, 1, 2].map((i) => ({
						el: document.getElementById(`s${i}`),
						frame: 0,
						last: null,
						state: [],
					}));
					this.frames = [];
					this.layouts = [[1], [2, 2], [3, 4]]; // [visible, variants]
					this.layout = [0, 0]; // [size, variant]
					this.prev = [0, 0];
					this.focus = 0;
					this.keys = new Map();

					window.addEventListener('keydown', (e) =>
						this.key(e, true),
					);
					window.addEventListener('keyup', (e) => this.key(e, false));
					this.init();
				}

				async init() {
					const { frames } = await fetch(this.api).then((r) =>
						r.json(),
					);
					this.frames = frames;
					this.spaces.forEach(
						(s) => (s.state = frames.map(() => new Map())),
					);
					this.render();
				}

				key(e, down) {
					const k = this.keys.get(e.key.toLowerCase());
					if (!k) return;
					e.preventDefault();
					k.down = down;
					if (down) k.fn?.(e);
				}

				on(key, fn, global = false) {
					this.keys.set(key.toLowerCase(), {
						fn,
						global,
						down: false,
					});
					return this;
				}

				write(key, val) {
					const s = this.spaces[this.focus];
					s.state[s.frame].set(key, val);
				}

				read() {
					const s = this.spaces[this.focus];
					return Object.fromEntries(s.state[s.frame]);
				}

				layout(n) {
					if (n === 0) {
						[this.layout, this.prev] = this.layout[0]
							? [[0, 0], this.layout]
							: [this.prev, this.prev];
					} else {
						this.focus = Math.min(this.focus, n - 1);
						this.layout = [
							n,
							this.layout[0] === n
								? (this.layout[1] + 1) % this.layouts[n][1]
								: 0,
						];
					}
					this.render();
				}

				tab() {
					this.focus = (this.focus + 1) % this.layout[0] || 1;
					this.render();
				}

				nav(d) {
					const s = this.spaces[this.focus];
					s.frame =
						(s.frame + d + this.frames.length) % this.frames.length;
					this.render();
				}

				exec(s) {
					this.keys.forEach(
						(v, k) => !v.global && this.keys.delete(k),
					);
					const html = this.frames[s.frame];
					s.el.innerHTML = html;
					s.last = html;
					s.el.querySelectorAll('script, style').forEach((old) => {
						const el = document.createElement(
							old.tagName.toLowerCase(),
						);
						[...old.attributes].forEach((a) =>
							el.setAttribute(a.name, a.value),
						);
						el.textContent = old.textContent;
						old.replaceWith(el);
					});
				}

				render() {
					const [size, variant] = this.layout;
					document.getElementById('universe').className = size
						? `l${size}-${variant}`
						: 'l0';
					const visible = size || 1;

					this.spaces.forEach((s, i) => {
						const show = i < visible;
						s.el.classList.toggle('hide', !show);
						if (
							show &&
							(s.last !== this.frames[s.frame] ||
								i === this.focus)
						) {
							this.exec(s);
						}
					});
				}
			}

			document.addEventListener('DOMContentLoaded', () => {
				const u = (window.pathless = new Universe());
				u.on('tab', () => u.tab(), true);
				u.on('1', () => u.layout(0), true);
				u.on('2', () => u.layout(1), true);
				u.on('3', () => u.layout(2), true);
				u.on('q', () => u.nav(-1), true);
				u.on('e', () => u.nav(1), true);
				window.space = (i) => u.spaces[i ?? u.focus].el;
				window.frame = () => u.spaces[u.focus].el.firstElementChild;
				window.onKey = (k, fn) => u.on(k, fn);
				window.write = (k, v) => u.write(k, v);
				window.read = () => u.read();
			});
		</script>
	</body>
</html>
